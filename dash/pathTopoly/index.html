<!doctype html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="viewport" id="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

    <title>Osmoscape:Path to Polygon Converter</title>
    <link rel="apple-touch-icon" href="../../assets/images/osmo_icon.png">

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.11/paper-full.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3.9.0/notyf.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js" integrity="sha512-AA1Bzp5Q0K1KanKKmvN/4d3IRKVlv9PYgwFPvm32nPO6QS8yH1HO7LbgB1pgiOxPtfeg5zEn2ba64MUcqJx6CA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- stylesheet Links -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" >
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/notyf@3.9.0/notyf.min.css" rel="stylesheet">
    <style>
        figure {
            border: 1px solid grey;
            display: inline-block;
            padding: 10px;
        }
        output {
            display: block;
        }
    </style>
  </head>
  <body>
    <script type='text/javascript' src='./js/pathseg.js'></script>
    <script>
        var settings = {
            divideXBy: 1,
            divideYBy: 1,
            units: '',
            precision: 3
        };
        function pointCommandsToSVGPoints(pointCommands) {
            return pointCommands.map(function(value, index, array) {
                return ((index % 2 == 1) ? ',' : ' ') + value;
            }).join('');
        }
        function pointCommandsToCSSPoints(pointCommands, settings, spaced = true) {
          if(spaced){
            return pointCommands.map(function(value, index, array) {
                return  (value / (index % 2 == 0 ? settings.divideXBy : settings.divideYBy)).toFixed(settings.precision)
                        + settings.units + ((index % 2 == 1 && index < array.length - 1) ? ',' : '');
            }).join(' ');
          }else{
            return pointCommands.map(function(value, index, array) {
                return  (value / (index % 2 == 0 ? settings.divideXBy : settings.divideYBy)).toFixed(settings.precision)
                        + settings.units + ((index % 2 == 1 && index < array.length - 1) ? '' : '');
            }).join(',');
          }
        }
        function processPaths(_json, _type, mainid, targetid){
          console.log('processPaths ' + _json + ' ' + _type + ' ' + mainid + ' ' + targetid);
          if(_json.shapes[targetid] == undefined)
            _json.shapes[targetid] = [];
          //
          var paths = document.querySelectorAll(mainid+' path');
          var cssPolygons = ['<ul>'];
          for (var i = 0; i < paths.length; i++) {
              var path = paths[i];
              var points = pathToPoints(path.pathSegList);
              var polygonSVGPoints = pointCommandsToSVGPoints(points);

              var polygon = document.createElementNS('http://www.w3.org/2000/svg','polygon');
              polygon.setAttributeNS(null, 'fill', '#cecece');
              polygon.setAttributeNS(null, 'points', polygonSVGPoints);
              path.parentNode.replaceChild(polygon, path);

              cssPolygons.push('<li>', 'polygon(', pointCommandsToCSSPoints(points, settings), ')', '</li>');
              //
              if(_type == 'mask')
                _json.shapes.push({"shape": pointCommandsToCSSPoints(points, settings, false).split(',').map(Number)});
              if(_type == 'sound')
                _json.shapes[targetid].push({"shape": pointCommandsToCSSPoints(points, settings, false).split(',').map(Number)});
              //
          }
          //
          var polygons = document.querySelectorAll(mainid + ' polygon');
          for (var i = 0; i < polygons.length; i++) {
              var poly = polygons[i];
              let points = [];
              for(j=0;j<poly.points.length;j++){
                points.push(poly.points[j].x);
                points.push(poly.points[j].y);
              }
              var polygonSVGPoints = pointCommandsToSVGPoints(points);

              var polygon = document.createElementNS('http://www.w3.org/2000/svg','polygon');
              polygon.setAttributeNS(null, 'fill', '#cecece');
              polygon.setAttributeNS(null, 'points', polygonSVGPoints);
              poly.parentNode.replaceChild(polygon, poly);

              cssPolygons.push('<li>', 'polygon(', pointCommandsToCSSPoints(points, settings), ')', '</li>');
              //
              if(_type == 'mask')
                _json.shapes.push({"shape": pointCommandsToCSSPoints(points, settings, false).split(',').map(Number)});
              if(_type == 'sound')
                _json.shapes[targetid].push({"shape": pointCommandsToCSSPoints(points, settings, false).split(',').map(Number)});
              //
          }
          //
          var rectangles = document.querySelectorAll(mainid + ' rect');
          for (var i = 0; i < rectangles.length; i++) {
              var rect = rectangles[i];
              let points = [];
              points.push(parseFloat(rect.getAttribute('x')));
              points.push(parseFloat(rect.getAttribute('y')));
              points.push(parseFloat(rect.getAttribute('x')) + parseFloat(rect.getAttribute('width')));
              points.push(parseFloat(rect.getAttribute('y')) + parseFloat(rect.getAttribute('height')));
              var polygonSVGPoints = pointCommandsToSVGPoints(points);
          

              var polygon = document.createElementNS('http://www.w3.org/2000/svg','polygon');
              polygon.setAttributeNS(null, 'fill', '#cecece');
              polygon.setAttributeNS(null, 'points', polygonSVGPoints);
              rect.parentNode.replaceChild(polygon, rect);
              cssPolygons.push('<li>', 'polygon(', pointCommandsToCSSPoints(points, settings), ')', '</li>');
              if(_type == 'mask')
                _json.shapes.push({"shape": pointCommandsToCSSPoints(points, settings, false).split(',').map(Number)});
              if(_type == 'sound')
                _json.shapes[targetid].push({"shape": pointCommandsToCSSPoints(points, settings, false).split(',').map(Number)});
          }
          //
          cssPolygons.push('</ul>');
          document.getElementById('output').innerHTML = cssPolygons.join('');
          //
          return _json;
        }

        function pathToPoints(segments) {
            var count = segments.numberOfItems;
            var result = [], segment, x, y;
            for (var i = 0; i < count; i++) {
                segment = segments.getItem(i);
                switch(segment.pathSegType) {
                    case SVGPathSeg.PATHSEG_MOVETO_ABS:
                    case SVGPathSeg.PATHSEG_LINETO_ABS:
                    case SVGPathSeg.PATHSEG_CURVETO_CUBIC_ABS:
                    case SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_ABS:
                    case SVGPathSeg.PATHSEG_ARC_ABS:
                    case SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_ABS:
                    case SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_ABS:
                        x = segment.x;
                        y = segment.y;
                        break;

                    case SVGPathSeg.PATHSEG_MOVETO_REL:
                    case SVGPathSeg.PATHSEG_LINETO_REL:
                    case SVGPathSeg.PATHSEG_CURVETO_CUBIC_REL:
                    case SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_REL:
                    case SVGPathSeg.PATHSEG_ARC_REL:
                    case SVGPathSeg.PATHSEG_CURVETO_CUBIC_SMOOTH_REL:
                    case SVGPathSeg.PATHSEG_CURVETO_QUADRATIC_SMOOTH_REL:
                        x = segment.x;
                        y = segment.y;
                        if (result.length > 0) {
                            x += result[result.length - 2];
                            y += result[result.length - 1];
                        }
                        break;

                    case SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_ABS:
                        x = segment.x;
                        y = result[result.length - 1];
                        break;
                    case SVGPathSeg.PATHSEG_LINETO_HORIZONTAL_REL:
                        x = result[result.length - 2] + segment.x;
                        y = result[result.length - 1];
                        break;

                    case SVGPathSeg.PATHSEG_LINETO_VERTICAL_ABS:
                        x = result[result.length - 2];
                        y = segment.y;
                        break;
                    case SVGPathSeg.PATHSEG_LINETO_VERTICAL_REL:
                        x = result[result.length - 2];
                        y = segment.y + result[result.length - 1];
                        break;
                    case SVGPathSeg.PATHSEG_CLOSEPATH:
                        return result;
                    default:
                        console.log('unknown path command: ', segment.pathSegTypeAsLetter);
                }
                result.push(x, y);
            }
            return result;
        }
        function crunch(_download, _type, _fname) {
          console.log('Curunching: ' + _type + ' ' + _download + ' ' + _fname);
          //
          let p2_json = {
            viewport: null,
            shapes: []
          };
          //
          if(_download && _type == 'sound'){
            p2_json = {
              viewport: null,
              shapes: {}
            };
          }
          //
          var svg = document.querySelector('#svg-original svg');
          var viewPort = svg.getAttribute('viewBox');
          if (!viewPort)
              viewPort = svg.getAttribute('x') + ' ' + svg.getAttribute('y')
                          + ' ' + svg.getAttribute('width') + ' ' + svg.getAttribute('height');
          p2_json.viewport = viewPort;
          document.getElementById('viewbox').innerHTML = 'ViewPort: ' + viewPort;
          document.getElementById('svg-result').innerHTML = document.getElementById('svg-original').innerHTML;
          //
          let multiple_ = $('#svg-result').find('#multiple');
          if(multiple_.length != 0){
            let multiple_masks = multiple_.children();
            for(let m=0; m < multiple_masks.length; m++){
              let _mask = multiple_masks[m];
              let id = $(_mask).attr('id');
              console.log('processing ' + id);
              p2_json = processPaths(p2_json, _type, '#'+id, id);
            }
          }else{
            console.log('processing default');
            p2_json = processPaths(p2_json, _type, '#svg-result', 'default');
          }
          //
          console.log(p2_json);
          //
          if(_download)
            download(JSON.stringify(p2_json), _fname+'.json', 'text/plain');
          //
        }
        function download(content, fileName, contentType) {
            var a = document.createElement("a");
            var file = new Blob([content], {type: contentType});
            a.href = URL.createObjectURL(file);
            a.download = fileName;
            a.click();
        }
        window.onload = function() {
            //
            //
            swal("Do you want to batch convert all the polygons?", {
              buttons: [true, "Do it!"],
              timer: 10000
            }).then((value) => {
              if(value){
                swal("Which of the following do you want to convert?", {
                  buttons: {
                    cancel: "Cancel",
                    mask: true,
                    sound: true,
                  },
                })
                .then((value2) => {
                  let type = value2;
                  if(type == 'cancel'){
                    var picker = document.getElementById("files");
                    picker.addEventListener('change', function(evt) {
                        var files = evt.target.files;
                        if (files.length < 1)
                            return;
                        var f = files[0];
                        if (f.type != 'image/svg+xml')
                            return;
                        var reader = new FileReader();
                        reader.onload = (function(theFile) {
                            return function(e) {
                                var result = e.target.result;
                                // some programs add extra markup at the beginning, we remove that here
                                result = result.replace(/^[\s\S]*(<svg)/i, "$1");
                                document.getElementById('svg-original').innerHTML = result;
                                crunch(false);
                            };
                        })(f);
                        reader.readAsText(f);
                    }, false);
                  }else{
                    //
                    $('#my-gui-container').hide();
                    //
                    let dataURL = './assets/data/dataSummary.json';
                    let allSVGDataPromises = [];
                    $.getJSON(dataURL, function( data ) {
                      console.log('Loaded datasets summary');
                      //
                      let datasets = data;
                      for (let id in datasets){
                        let mpath = datasets[id].maskpath;
                        //
                        if(type == 'mask'){
                          let pieces = mpath.split('/');
                          let fname = pieces[pieces.length-1];
                          pieces[pieces.length-1] = 'Debug';
                          pieces.push(fname);
                          mpath = pieces.join('/');
                        }
                        if(type == 'sound'){
                          let pieces = mpath.split('/');
                          let fname = pieces[pieces.length-1];
                          pieces[pieces.length-1] = 'Sound';
                          pieces.push(fname);
                          mpath = pieces.join('/');
                        }
                        //
                        console.log(mpath);
                        setTimeout(function(){
                          fetch(mpath)
                            .then(r => r.text())
                            .then(text => {
                                //
                                let result = text;
                                // some programs add extra markup at the beginning, we remove that here
                                result = result.replace(/^[\s\S]*(<svg)/i, "$1");
                                document.getElementById('svg-original').innerHTML = result;
                                crunch(true, type, mpath.substring(mpath.lastIndexOf('/')+1));
                                //
                                //
                            })
                            .catch((err)=>{
                                console.log(err);
                                console.log('Failed to load: ' + id)
                            });
                        },1000*id)
                        //
                      }
                      //
                    },1000);

                  }
                });
              }else{
                var picker = document.getElementById("files");
                picker.addEventListener('change', function(evt) {
                    var files = evt.target.files;
                    if (files.length < 1)
                        return;
                    var f = files[0];
                    if (f.type != 'image/svg+xml')
                        return;
                    var reader = new FileReader();
                    reader.onload = (function(theFile) {
                        return function(e) {
                            var result = e.target.result;
                            // some programs add extra markup at the beginning, we remove that here
                            result = result.replace(/^[\s\S]*(<svg)/i, "$1");
                            document.getElementById('svg-original').innerHTML = result;
                            crunch(false);
                        };
                    })(f);
                    reader.readAsText(f);
                }, false);
              }
            });;
            //
            //
        }
    </script>
    <header class='jumbotron subhead'>
        <div class='row'>
            <div class='span8'>
                <h1>Path to Polygon Converter</h1>
                <p class='lead'>Use this to convert single (or) entire batch of svg paths into polygons suitable for use as P2 Collision Shapes.</p>
            </div>
            <div class='span4' id="my-gui-container">
                <input id="files" type="file" name="files[]" />
            </div>
        </div>
    </header>
    <output id="viewbox"></output>
    <output id="output"></output>
    <figure>
        <figcaption>Input Preview (with Paths)</figcaption>
        <div id="svg-original">
        </div>
    </figure>
    <figure>
    <figcaption>Output Preview (with Polygons)</figcaption>
    <div id="svg-result">
    </div>
    </figure>
  </body>

